# **Bag-report**
__*[tcp-deamon](https://github.com/nikonok/tcpdeamon)*__

### Segmentation fault
Одной из причин ошибки является неправило переданные(один или несколько аргументов)
Например, `curl -F "md5=ab5f2dc27085b9ceb01337fdcf18fb0b" -F "filemane=CV.pdf" -F "image=@/home/anton/CV.pdf" http://localhost:80`. Из-за ошибки в __filemane__ *(вместо filename)* программа не может распарсить параметр имени файла и файл не создается, запись не идет. Позже, после обработки всего запроса, программы пытается закрыть файл `fclose(...)`, на этом моменте и происходит *аварийное завершение* программы.

### Permission denied
Возникает про попытке перезваписи `deamon_log.txt`.
Проблема в том, что не выставлены флаги доступы при открытии: `int log_file = open(logfilename, O_WRONLY | O_CREAT);`
Нужно добавить аргумент вида `S_IRWXU` (владелец имеет право на чтения, запись и исполнение), либо другой флаг.

### Bind error
Из-за того, что не организовано корректное завершение программы, за процессом может остаться занятый их порт.(Выполнение программы не доходит до `close(listener)`.

### MD5
Если аргументы в POST поменялись местами, например файл идет первым, то он не будет записан не полностью, что ведет к не совпадению md5 суммы. Решением является использование сторонних библиотек или программ парсинга HTTP запросов.

### Ошибки работы с файлами
Не проверяются ошибки функции `read(...)`. Например ошибка __errno__ = `EINTR` (вызов прерван сигналом, до того как были считаны байты). Аналогичная ошибка и с `write()`. Решить можно добавлением функции записи с телом:
```
ssize_t ret, nr;
while(len != 0 && (ret = write(fd, buf, len)) != 0){
    if (ret == -1){
        if (errno == EINTR)
            continue;;
        perror("write");
        break;
    }

    len -= ret;
    buf += ret;
}
```
Такая функция проведет полную запись буфера.
Так же никак не обрабатываются ошибки функции `fclose(...)`.


## Summary
В программе не возникнет ошибки если отправлять POST в соответствии со "стандартом", описанным в `README.md`.
Но отправлять строго так, как написано не выход. Любая опечатка с запросе ведет к завершению программы.
Так же в ней не организовано корректное завершение.
Из-за того, что парсинг организован сразу в программе, без сторонних библиотек/программ ([например](https://github.com/nodejs/http-parser) ) может не происходить запись в файл или файл может быть не полным.
Для доработки задачи до приемлимого уровня необходимо как минимум организовать более динамичный парсинг POST запроса, что влечет к переписыванию большой части логики программы.
